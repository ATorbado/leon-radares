name: Radares León (diario)

on:
  schedule:
    - cron: "15 22 * * *"   # 00:10 Europe/Madrid cuando es UTC+2 (verano)
    - cron: "15 23 * * *"   # 00:10 Europe/Madrid cuando es UTC+1 (invierno)
    - cron: "25 23 * * *"  # Reintento ~01:15 Madrid
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Instalación limpia (sin lockfile)
      - name: Clean install
        run: |
          rm -rf node_modules package-lock.json
          npm i --prefer-online --no-audit --no-fund

      - name: Sanity check (no pdf-parse)
        run: node -e "console.log('Has pdf-parse?', require('fs').existsSync('node_modules/pdf-parse'))"

      - name: Lista de archivos
        run: |
          ls -la
          ls -la scripts || true
          ls -la radars || true

      - name: Generar GeoJSON de hoy (verbose)
        run: |
          node -v
          npm -v
          node --trace-warnings scripts/fetch_radars.js
          echo "--- stat today.geojson ---"
          node -e "console.log(require('fs').statSync('radars/today.geojson'))"
          echo "--- head today.geojson ---"
          head -n 60 radars/today.geojson || true

      - name: Preparar commit (si cambió)
        id: commit
        run: |
          set -e
          FILES="radars/today.geojson"
          if [ -f radars/latest_pdf.txt ]; then
            FILES="$FILES radars/latest_pdf.txt"
          fi

          git add $FILES || true

          if git diff --cached --quiet; then
            echo "Sin cambios que commitear"
            echo "did_commit=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "update radars today"
          echo "did_commit=true" >> $GITHUB_OUTPUT

      - name: Push con rebase y reintento
        if: steps.commit.outputs.did_commit == 'true'
        run: |
          set -e
          tries=3
          for i in $(seq 1 $tries); do
            if git push origin HEAD:main; then
              echo "Push OK"
              exit 0
            fi
            echo "Push rechazado, haciendo fetch+rebase e intentando de nuevo ($i/$tries)..."
            git fetch origin main
            git pull --rebase origin main
          done
          echo "Fallo al push tras $tries intentos"
          exit 1

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
